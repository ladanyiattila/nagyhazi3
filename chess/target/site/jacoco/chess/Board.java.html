<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Board.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Coverage with JaCoCo and Maven</a> &gt; <a href="index.source.html" class="el_package">chess</a> &gt; <span class="el_source">Board.java</span></div><h1>Board.java</h1><pre class="source lang-java linenums">package chess;

import javax.swing.*;

import java.awt.BorderLayout;
import java.awt.Color;
import java.awt.Component;
import java.awt.Dimension;
import java.awt.FlowLayout;
import java.awt.Font;
import java.awt.event.ActionEvent;
import java.awt.event.MouseAdapter;

import javax.swing.table.DefaultTableCellRenderer;
import javax.swing.table.DefaultTableModel;

import java.awt.event.MouseEvent;

import java.util.*;

import pieces.*;

/**
 * A játék táblájának megvalósításáért felelős osztály
 */
public class Board {
    private static JPanel boardPanel;
<span class="fc" id="L28">    private static final String[] columns = { &quot;&quot;, &quot;A&quot;, &quot;B&quot;, &quot;C&quot;, &quot;D&quot;, &quot;E&quot;, &quot;F&quot;, &quot;G&quot;, &quot;H&quot; };</span>
    private static List&lt;Piece&gt; actualPosition;
    private static JTable boardTable;
    private static PieceColor nextMoveColor;
    private static JFrame endOfGame;
    private static String movesListed;
    private static int numberOfMoves;
    private static JTextArea movesTextArea;
    private static JFrame promotionFrame;
    private static List&lt;Position&gt; possibleMoves;
<span class="fc" id="L38">    private static Piece clickedPiece;</span>

    private DefaultTableModel tableModel;
    private Piece lastMovePiece;
    private Position lastMovePosition;

    /**
     * Board konstruktor
     * 
     * Paraméterként egy beolvasott játékállás tulajdonságait (állás, lépések
     * leírva,
     * lépések száma, következő lépést végző játékos) és a lépéseket megjelenítő
     * JTextArea-t kapja meg.
     * 
     * @param startingPos
     * @param movesListed
     * @param numberOfMoves
     * @param movesTextArea
     * @param nextMoveColor
     */
<span class="nc" id="L58">    public Board(List&lt;Piece&gt; startingPos, String movesListed, int numberOfMoves, JTextArea movesTextArea,</span>
            PieceColor nextMoveColor) {
        // fehér kezd alapértelmezetten
<span class="nc bnc" id="L61" title="All 2 branches missed.">        if (nextMoveColor != null) {</span>
<span class="nc" id="L62">            this.nextMoveColor = nextMoveColor;</span>
<span class="nc" id="L63">        } else {</span>
<span class="nc" id="L64">            this.nextMoveColor = PieceColor.WHITE;</span>
        }

        // ne lehessen többször megnyitni az ablakot
<span class="nc" id="L68">        endOfGame = null;</span>
<span class="nc" id="L69">        promotionFrame = null;</span>

        // a felállás beállítása
<span class="nc bnc" id="L72" title="All 2 branches missed.">        if (startingPos == null) {</span>
<span class="nc" id="L73">            actualPosition = getStartingPosition();</span>
<span class="nc" id="L74">        } else {</span>
<span class="nc" id="L75">            actualPosition = startingPos;</span>
        }

        // beolvasás esetén a lépések, lépések száma
<span class="nc" id="L79">        this.movesListed = movesListed;</span>
<span class="nc" id="L80">        this.numberOfMoves = numberOfMoves;</span>

        // a lépéseket megjelenítő JTextArea-hoz hozzáférhessen, hogy annak tartalmát
        // frissíthesse
<span class="nc" id="L84">        this.movesTextArea = movesTextArea;</span>

        // alapértelmezetten null
<span class="nc" id="L87">        possibleMoves = null;</span>
<span class="nc" id="L88">        clickedPiece = null;</span>

<span class="nc" id="L90">        boardPanel = new JPanel();</span>
<span class="nc" id="L91">        boardPanel.setPreferredSize(new Dimension(675, 750));</span>

<span class="nc" id="L93">        String[][] rows = new String[9][9];</span>
<span class="nc" id="L94">        tableModel = new DefaultTableModel(rows, columns);</span>
<span class="nc" id="L95">        boardTable = new JTable(tableModel) {</span>
            @Override
            public boolean isCellEditable(int row, int column) {
<span class="nc" id="L98">                return false;</span>
            }
        };

<span class="nc" id="L102">        boardTable.setRowHeight(75);</span>
<span class="nc" id="L103">        boardTable.setCellSelectionEnabled(true);</span>
<span class="nc" id="L104">        boardTable.getSelectionModel().setSelectionMode(ListSelectionModel.SINGLE_SELECTION);</span>
<span class="nc" id="L105">        boardTable.getColumnModel().getSelectionModel().setSelectionMode(ListSelectionModel.SINGLE_SELECTION);</span>

        // a cellák megjelenítéséhez CellRenderer
<span class="nc bnc" id="L108" title="All 2 branches missed.">        for (int i = 0; i &lt; 9; i++) {</span>
<span class="nc" id="L109">            CellRenderer renderer = new CellRenderer();</span>
<span class="nc" id="L110">            boardTable.getColumnModel().getColumn(i).setCellRenderer(renderer);</span>
        }

        // a táblára való kattintáskor a lépések lekezelése
<span class="nc" id="L114">        boardTable.addMouseListener(new ClickedOnTable());</span>

<span class="nc" id="L116">        boardPanel.add(boardTable);</span>
<span class="nc" id="L117">    }</span>

    /**
     * Az alapfelállás bábuinak listáját hozza létre és tér vissza a listával
     * 
     * @return List&lt;Piece&gt;
     */
    public static List&lt;Piece&gt; getStartingPosition() {
<span class="fc" id="L125">        List&lt;Piece&gt; pieces = new ArrayList&lt;&gt;();</span>

        // sötét bábuk
<span class="fc" id="L128">        pieces.add(new Rook(PieceColor.BLACK, new Position(&quot;a&quot;, 8)));</span>
<span class="fc" id="L129">        pieces.add(new Rook(PieceColor.BLACK, new Position(&quot;h&quot;, 8)));</span>
<span class="fc" id="L130">        pieces.add(new Knight(PieceColor.BLACK, new Position(&quot;b&quot;, 8)));</span>
<span class="fc" id="L131">        pieces.add(new Knight(PieceColor.BLACK, new Position(&quot;g&quot;, 8)));</span>
<span class="fc" id="L132">        pieces.add(new Bishop(PieceColor.BLACK, new Position(&quot;c&quot;, 8)));</span>
<span class="fc" id="L133">        pieces.add(new Bishop(PieceColor.BLACK, new Position(&quot;f&quot;, 8)));</span>
<span class="fc" id="L134">        pieces.add(new Queen(PieceColor.BLACK, new Position(&quot;d&quot;, 8)));</span>
<span class="fc" id="L135">        pieces.add(new King(PieceColor.BLACK, new Position(&quot;e&quot;, 8)));</span>

        // 8 gyalog
<span class="fc bfc" id="L138" title="All 2 branches covered.">        for (int i = 0; i &lt; 8; i++) {</span>
<span class="fc" id="L139">            pieces.add(new Pawn(PieceColor.BLACK, new Position(columns[i + 1].toLowerCase(), 7)));</span>
        }

        // világos bábuk
<span class="fc" id="L143">        pieces.add(new Rook(PieceColor.WHITE, new Position(&quot;a&quot;, 1)));</span>
<span class="fc" id="L144">        pieces.add(new Rook(PieceColor.WHITE, new Position(&quot;h&quot;, 1)));</span>
<span class="fc" id="L145">        pieces.add(new Knight(PieceColor.WHITE, new Position(&quot;b&quot;, 1)));</span>
<span class="fc" id="L146">        pieces.add(new Knight(PieceColor.WHITE, new Position(&quot;g&quot;, 1)));</span>
<span class="fc" id="L147">        pieces.add(new Bishop(PieceColor.WHITE, new Position(&quot;c&quot;, 1)));</span>
<span class="fc" id="L148">        pieces.add(new Bishop(PieceColor.WHITE, new Position(&quot;f&quot;, 1)));</span>
<span class="fc" id="L149">        pieces.add(new Queen(PieceColor.WHITE, new Position(&quot;d&quot;, 1)));</span>
<span class="fc" id="L150">        pieces.add(new King(PieceColor.WHITE, new Position(&quot;e&quot;, 1)));</span>

        // 8 gyalog
<span class="fc bfc" id="L153" title="All 2 branches covered.">        for (int i = 0; i &lt; 8; i++) {</span>
<span class="fc" id="L154">            pieces.add(new Pawn(PieceColor.WHITE, new Position(columns[i + 1].toLowerCase(), 2)));</span>
        }

<span class="fc" id="L157">        return pieces;</span>
    }

    /**
     * Visszaadja a paraméterként kapott mezőn elhelyezkedő bábut;
     * ha nincs ilyen, akkor null a visszatérési érték
     * 
     * @param position
     * @return Piece
     */
    private static Piece getPieceInActualPosition(Position position) {
<span class="nc bnc" id="L168" title="All 2 branches missed.">        for (Piece piece : actualPosition) {</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">            if (piece.getPosition().equals(position)) {</span>
<span class="nc" id="L170">                return piece;</span>
            }
        }

<span class="nc" id="L174">        return null;</span>
    }

    /**
     * Igaz, ha a paraméterként kapott mező szerepel a lehetséges lépések között.
     * Egyébként hamis (ha null a mező, akkor is).
     * 
     * @param pos
     * @return boolean
     */
    private static boolean isInPossibleMove(Position pos) {
<span class="nc bnc" id="L185" title="All 2 branches missed.">        if (possibleMoves == null) {</span>
<span class="nc" id="L186">            return false;</span>
        }

<span class="nc bnc" id="L189" title="All 2 branches missed.">        for (Position position : possibleMoves) {</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">            if (position.equals(pos)) {</span>
<span class="nc" id="L191">                return true;</span>
            }
        }
<span class="nc" id="L194">        return false;</span>
    }

    /**
     * Lekérdezi az aktuális állásra, hogy vége van-e már a játéknak:
     * - ha nem, akkor nem történik semmi
     * - ha igen, akkor megjeleníti az ablakot, melyen a játék
     * eredménye látható és vissza lehet térni a főmenübe
     */
    private static void checkBoardAfterEveryMove() {
<span class="nc" id="L204">        String state = Rules.getEndOfGame(actualPosition, nextMoveColor);</span>

<span class="nc bnc" id="L206" title="All 2 branches missed.">        if (!state.equals(&quot;NOT_FINISHED&quot;)) {</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">            if (endOfGame == null) {</span>
<span class="nc" id="L208">                endOfGame = new JFrame();</span>
            }
<span class="nc" id="L210">            endOfGame.setSize(400, 200);</span>
<span class="nc" id="L211">            endOfGame.setResizable(false);</span>
<span class="nc" id="L212">            endOfGame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);</span>
<span class="nc" id="L213">            endOfGame.setTitle(&quot;Chess&quot;);</span>
<span class="nc" id="L214">            endOfGame.setLayout(new BorderLayout());</span>

<span class="nc" id="L216">            JPanel textPanel = new JPanel();</span>
<span class="nc" id="L217">            textPanel.setLayout(new FlowLayout(FlowLayout.CENTER, 0, 0));</span>
<span class="nc" id="L218">            textPanel.setPreferredSize(new Dimension(400, 300));</span>

<span class="nc" id="L220">            JLabel label = new JLabel();</span>
<span class="nc" id="L221">            String text = &quot;End of game by &quot; + state;</span>
<span class="nc" id="L222">            label.setText(text);</span>
<span class="nc" id="L223">            label.setFont(new Font(&quot;Arial&quot;, 0, 20));</span>
<span class="nc" id="L224">            textPanel.add(label);</span>

<span class="nc bnc" id="L226" title="All 2 branches missed.">            if (state.equals(&quot;CHECKMATE&quot;)) {</span>
<span class="nc" id="L227">                JLabel winner = new JLabel(</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">                        &quot;The winner is: &quot; + (nextMoveColor == PieceColor.WHITE ? PieceColor.BLACK : PieceColor.WHITE));</span>
<span class="nc" id="L229">                winner.setFont(new Font(&quot;Arial&quot;, 0, 20));</span>
<span class="nc" id="L230">                textPanel.add(winner);</span>
            }

<span class="nc" id="L233">            JButton button = new JButton(&quot;Back to main menu&quot;);</span>
<span class="nc" id="L234">            button.addActionListener((ActionEvent ae) -&gt; {</span>
<span class="nc" id="L235">                boardPanel.setVisible(false);</span>
<span class="nc" id="L236">                endOfGame.setVisible(false);</span>
<span class="nc" id="L237">                Program.startProgram();</span>
<span class="nc" id="L238">            });</span>

<span class="nc" id="L240">            endOfGame.add(textPanel, BorderLayout.NORTH);</span>
<span class="nc" id="L241">            endOfGame.add(button, BorderLayout.SOUTH);</span>
<span class="nc" id="L242">            endOfGame.setVisible(true);</span>
        }
<span class="nc" id="L244">    }</span>

    /**
     * Hozzáadja a lépések szövegéhez a paraméterként kapott lépést, majd ezt
     * a JTextArea-n is frissíti
     * 
     * @param move
     */
    private static void addMove(String move) {
<span class="nc bnc" id="L253" title="All 2 branches missed.">        if (nextMoveColor == PieceColor.WHITE) {</span>
<span class="nc" id="L254">            movesListed += numberOfMoves + &quot;.&quot; + move + &quot; &quot;;</span>
<span class="nc" id="L255">        } else {</span>
<span class="nc" id="L256">            movesListed += move + &quot;\n&quot;;</span>
<span class="nc" id="L257">            numberOfMoves++;</span>
        }

<span class="nc" id="L260">        movesTextArea.repaint();</span>
<span class="nc" id="L261">        movesTextArea.setText(movesListed);</span>
<span class="nc" id="L262">    }</span>

    /**
     * movesListed paraméter getter függvénye
     * 
     * @return String
     */
    public static String getMovesListedVariable() {
<span class="nc" id="L270">        return movesListed;</span>
    }

    /**
     * Frissíti az előléptetés után a PGN lépéseket
     * 
     * @param clickedPosition
     * @param wasPieceTaken
     * @param pieceLetter
     */
    private static void updateMovesText(Position clickedPosition, boolean wasPieceTaken, String pieceLetter) {
<span class="nc bnc" id="L281" title="All 2 branches missed.">        movesListed += (nextMoveColor == PieceColor.BLACK ? numberOfMoves + &quot;.&quot; : &quot;&quot;)</span>
<span class="nc" id="L282">                + PGN_Formatter.getMoveFormatted(clickedPiece, clickedPosition, wasPieceTaken, actualPosition) + &quot;=&quot;</span>
<span class="nc" id="L283">                + pieceLetter</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">                + (nextMoveColor == PieceColor.BLACK ? &quot; &quot; : &quot;\n&quot;);</span>

<span class="nc bnc" id="L286" title="All 2 branches missed.">        if (nextMoveColor == PieceColor.WHITE) {</span>
<span class="nc" id="L287">            numberOfMoves++;</span>
        }

<span class="nc" id="L290">        movesTextArea.repaint();</span>
<span class="nc" id="L291">        movesTextArea.setText(movesListed);</span>

<span class="nc" id="L293">        promotionFrame.setVisible(false);</span>
<span class="nc" id="L294">        boardTable.repaint();</span>
<span class="nc" id="L295">    }</span>

    /**
     * Átalakuláskor megjeleníti az ablakot, ahonnan választhat a játékos bábut,
     * illetve hozzáadja az álláshoz az új bábut
     * 
     * @param clickedPosition
     * @param wasPieceTaken
     */
    private static void promotionWindow(Position clickedPosition, boolean wasPieceTaken) {
<span class="nc bnc" id="L305" title="All 2 branches missed.">        if (promotionFrame == null) {</span>
<span class="nc" id="L306">            promotionFrame = new JFrame();</span>
        }

<span class="nc" id="L309">        promotionFrame.setSize(400, 200);</span>
<span class="nc" id="L310">        promotionFrame.setResizable(false);</span>
<span class="nc" id="L311">        promotionFrame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);</span>
<span class="nc" id="L312">        promotionFrame.setTitle(&quot;Promotion&quot;);</span>
<span class="nc" id="L313">        promotionFrame.setLayout(new BorderLayout());</span>

<span class="nc" id="L315">        JPanel textPanel = new JPanel();</span>
<span class="nc" id="L316">        textPanel.setLayout(new FlowLayout(FlowLayout.CENTER, 0, 0));</span>
<span class="nc" id="L317">        textPanel.setPreferredSize(new Dimension(400, 50));</span>

<span class="nc" id="L319">        JLabel label = new JLabel(&quot;Choose a piece: &quot;);</span>
<span class="nc" id="L320">        label.setFont(new Font(&quot;Arial&quot;, 0, 20));</span>
<span class="nc" id="L321">        textPanel.add(label);</span>

<span class="nc" id="L323">        JPanel buttonPanel = new JPanel();</span>
<span class="nc" id="L324">        buttonPanel.setLayout(new FlowLayout(FlowLayout.CENTER, 0, 0));</span>
<span class="nc" id="L325">        buttonPanel.setPreferredSize(new Dimension(400, 100));</span>

<span class="nc" id="L327">        JButton queenButton = new JButton();</span>
<span class="nc bnc" id="L328" title="All 2 branches missed.">        if (clickedPiece.getColor() == PieceColor.BLACK) {</span>
<span class="nc" id="L329">            queenButton.setIcon(new ImageIcon(&quot;piece_images/black_queen.png&quot;));</span>
<span class="nc" id="L330">        } else {</span>
<span class="nc" id="L331">            queenButton.setIcon(new ImageIcon(&quot;piece_images/white_queen.png&quot;));</span>
        }
<span class="nc" id="L333">        queenButton.addActionListener((ActionEvent e) -&gt; {</span>
<span class="nc" id="L334">            actualPosition.add(new Queen(clickedPiece.getColor(), clickedPosition));</span>
<span class="nc" id="L335">            updateMovesText(clickedPosition, wasPieceTaken, &quot;Q&quot;);</span>
<span class="nc" id="L336">        });</span>
<span class="nc" id="L337">        queenButton.setPreferredSize(new Dimension(80, 80));</span>
<span class="nc" id="L338">        buttonPanel.add(queenButton);</span>

<span class="nc" id="L340">        JButton rookButton = new JButton();</span>
<span class="nc bnc" id="L341" title="All 2 branches missed.">        if (clickedPiece.getColor() == PieceColor.BLACK) {</span>
<span class="nc" id="L342">            rookButton.setIcon(new ImageIcon(&quot;piece_images/black_rook.png&quot;));</span>
<span class="nc" id="L343">        } else {</span>
<span class="nc" id="L344">            rookButton.setIcon(new ImageIcon(&quot;piece_images/white_rook.png&quot;));</span>
        }
<span class="nc" id="L346">        rookButton.addActionListener((ActionEvent e) -&gt; {</span>
<span class="nc" id="L347">            actualPosition.add(new Rook(clickedPiece.getColor(), clickedPosition));</span>
<span class="nc" id="L348">            updateMovesText(clickedPosition, wasPieceTaken, &quot;R&quot;);</span>
<span class="nc" id="L349">        });</span>
<span class="nc" id="L350">        rookButton.setPreferredSize(new Dimension(80, 80));</span>
<span class="nc" id="L351">        buttonPanel.add(rookButton);</span>

<span class="nc" id="L353">        JButton knightButton = new JButton();</span>
<span class="nc bnc" id="L354" title="All 2 branches missed.">        if (clickedPiece.getColor() == PieceColor.BLACK) {</span>
<span class="nc" id="L355">            knightButton.setIcon(new ImageIcon(&quot;piece_images/black_knight.png&quot;));</span>
<span class="nc" id="L356">        } else {</span>
<span class="nc" id="L357">            knightButton.setIcon(new ImageIcon(&quot;piece_images/white_knight.png&quot;));</span>
        }
<span class="nc" id="L359">        knightButton.addActionListener((ActionEvent e) -&gt; {</span>
<span class="nc" id="L360">            actualPosition.add(new Knight(clickedPiece.getColor(), clickedPosition));</span>
<span class="nc" id="L361">            updateMovesText(clickedPosition, wasPieceTaken, &quot;N&quot;);</span>
<span class="nc" id="L362">        });</span>
<span class="nc" id="L363">        knightButton.setPreferredSize(new Dimension(80, 80));</span>
<span class="nc" id="L364">        buttonPanel.add(knightButton);</span>

<span class="nc" id="L366">        JButton bishopButton = new JButton();</span>
<span class="nc bnc" id="L367" title="All 2 branches missed.">        if (clickedPiece.getColor() == PieceColor.BLACK) {</span>
<span class="nc" id="L368">            bishopButton.setIcon(new ImageIcon(&quot;piece_images/black_bishop.png&quot;));</span>
<span class="nc" id="L369">        } else {</span>
<span class="nc" id="L370">            bishopButton.setIcon(new ImageIcon(&quot;piece_images/white_bishop.png&quot;));</span>
        }
<span class="nc" id="L372">        bishopButton.addActionListener((ActionEvent e) -&gt; {</span>
<span class="nc" id="L373">            actualPosition.add(new Bishop(clickedPiece.getColor(), clickedPosition));</span>
<span class="nc" id="L374">            updateMovesText(clickedPosition, wasPieceTaken, &quot;B&quot;);</span>
<span class="nc" id="L375">        });</span>
<span class="nc" id="L376">        bishopButton.setPreferredSize(new Dimension(80, 80));</span>
<span class="nc" id="L377">        buttonPanel.add(bishopButton);</span>

<span class="nc" id="L379">        promotionFrame.add(textPanel, BorderLayout.NORTH);</span>
<span class="nc" id="L380">        promotionFrame.add(buttonPanel, BorderLayout.SOUTH);</span>
<span class="nc" id="L381">        promotionFrame.setVisible(true);</span>
<span class="nc" id="L382">    }</span>

    /**
     * A tábla JPanel attribútumának getter függvénye
     * 
     * @return
     */
    public JPanel getBoardPanel() {
<span class="nc" id="L390">        return boardPanel;</span>
    }

    /**
     * A táblára történő kattintások kezeléséért felelős belső osztály:
     * - lekérdezi a lehetséges lépéseket
     * - lépés esetén frissíti az aktuális állást
     */
<span class="nc" id="L398">    class ClickedOnTable extends MouseAdapter {</span>
        private Piece pieceThere;
        private Position clickedPosition;
        private boolean wasPieceTaken;
        private boolean wasTherePromotion;
        private Position movedTo;

        /**
         * A kattintás egy bábura vonatkozik és az nem ütés
         */
        private void clickedOnPiece() {
<span class="nc" id="L409">            List&lt;Position&gt; allMoves = pieceThere.getEveryMove();</span>
<span class="nc" id="L410">            clickedPiece = pieceThere;</span>

<span class="nc" id="L412">            ListIterator&lt;Position&gt; iter = allMoves.listIterator();</span>

<span class="nc bnc" id="L414" title="All 2 branches missed.">            while (iter.hasNext()) {</span>
<span class="nc" id="L415">                Position current = iter.next();</span>

<span class="nc" id="L417">                if (!Rules.isMovePossible(actualPosition, pieceThere, current, nextMoveColor, true, true, lastMovePiece,</span>
<span class="nc bnc" id="L418" title="All 2 branches missed.">                        lastMovePosition)) {</span>
<span class="nc" id="L419">                    iter.remove();</span>
                }
            }

<span class="nc" id="L423">            possibleMoves = allMoves;</span>
<span class="nc" id="L424">        }</span>

        /**
         * Átalakulás esetén
         */
        private void promotion() {
<span class="nc" id="L430">            ListIterator&lt;Piece&gt; iterator = actualPosition.listIterator();</span>

<span class="nc bnc" id="L432" title="All 2 branches missed.">            while (iterator.hasNext()) {</span>
<span class="nc" id="L433">                Piece current = iterator.next();</span>

<span class="nc bnc" id="L435" title="All 2 branches missed.">                if (current.getPosition().equals(clickedPiece.getPosition())) {</span>
<span class="nc" id="L436">                    iterator.remove();</span>
<span class="nc" id="L437">                    break;</span>
                }
            }

<span class="nc" id="L441">            Board.promotionWindow(clickedPosition, wasPieceTaken);</span>
<span class="nc" id="L442">            boardTable.repaint();</span>
<span class="nc" id="L443">            wasTherePromotion = true;</span>
<span class="nc" id="L444">        }</span>

        /**
         * En passant esetén
         */
        private void enPassant() {
<span class="nc" id="L450">            ListIterator&lt;Piece&gt; iterator = actualPosition.listIterator();</span>

<span class="nc" id="L452">            Position pawnPos = new Position(clickedPosition.getColumn(),</span>
<span class="nc bnc" id="L453" title="All 2 branches missed.">                    clickedPosition.getRow() + (clickedPiece.getColor() == PieceColor.WHITE ? -1 : 1));</span>

<span class="nc bnc" id="L455" title="All 2 branches missed.">            while (iterator.hasNext()) {</span>
<span class="nc" id="L456">                Piece current = iterator.next();</span>

<span class="nc bnc" id="L458" title="All 2 branches missed.">                if (current.getPosition().equals(pawnPos)) {</span>
<span class="nc" id="L459">                    iterator.remove();</span>
                }
            }

<span class="nc" id="L463">            addMove(clickedPiece.getPosition().columnToString() + &quot;x&quot; + clickedPosition.columnToString()</span>
<span class="nc" id="L464">                    + clickedPosition.getRow());</span>
<span class="nc" id="L465">        }</span>

        /**
         * Sáncolás esetén
         */
        private void castling() {
<span class="nc bnc" id="L471" title="All 2 branches missed.">            int row = clickedPiece.getColor() == PieceColor.WHITE ? 1 : 8;</span>

            // rövid
<span class="nc bnc" id="L474" title="All 2 branches missed.">            if (movedTo.equals(new Position(&quot;g&quot;, row))) {</span>
<span class="nc bnc" id="L475" title="All 2 branches missed.">                for (Piece piece : actualPosition) {</span>
<span class="nc bnc" id="L476" title="All 2 branches missed.">                    if (piece.getType() == PieceType.ROOK</span>
<span class="nc bnc" id="L477" title="All 2 branches missed.">                            &amp;&amp; piece.getPosition().equals(new Position(&quot;h&quot;, row))) {</span>
<span class="nc" id="L478">                        piece.setPosition(new Position(&quot;f&quot;, row));</span>
<span class="nc" id="L479">                        piece.pieceHasMoved();</span>
<span class="nc" id="L480">                        lastMovePiece = clickedPiece;</span>
                    }
                }
            }

            // hosszú
<span class="nc bnc" id="L486" title="All 2 branches missed.">            if (movedTo.equals(new Position(&quot;c&quot;, row))) {</span>
<span class="nc bnc" id="L487" title="All 2 branches missed.">                for (Piece piece : actualPosition) {</span>
<span class="nc bnc" id="L488" title="All 2 branches missed.">                    if (piece.getType() == PieceType.ROOK</span>
<span class="nc bnc" id="L489" title="All 2 branches missed.">                            &amp;&amp; piece.getPosition().equals(new Position(&quot;a&quot;, row))) {</span>
<span class="nc" id="L490">                        piece.setPosition(new Position(&quot;d&quot;, row));</span>
<span class="nc" id="L491">                        piece.pieceHasMoved();</span>
<span class="nc" id="L492">                        lastMovePiece = clickedPiece;</span>
                    }
                }
            }
<span class="nc" id="L496">        }</span>

        /**
         * Egy bábu lépésének megvalósítása
         */
        private void executeMove() {
<span class="nc" id="L502">            ListIterator&lt;Piece&gt; iter = actualPosition.listIterator();</span>
<span class="nc" id="L503">            wasPieceTaken = false;</span>

            // ütés esetén a bábu törlése
<span class="nc bnc" id="L506" title="All 2 branches missed.">            while (iter.hasNext()) {</span>
<span class="nc" id="L507">                Piece current = iter.next();</span>

<span class="nc bnc" id="L509" title="All 2 branches missed.">                if (current.getPosition().equals(clickedPosition)) {</span>
<span class="nc" id="L510">                    iter.remove();</span>
<span class="nc" id="L511">                    wasPieceTaken = true;</span>
<span class="nc" id="L512">                    break;</span>
                }
            }

<span class="nc" id="L516">            movedTo = new Position(clickedPosition.getColumn(), clickedPosition.getRow());</span>
<span class="nc" id="L517">            wasTherePromotion = false;</span>

            // átalakulás
<span class="nc bnc" id="L520" title="All 2 branches missed.">            if (clickedPiece.getType() == PieceType.PAWN</span>
<span class="nc bnc" id="L521" title="All 4 branches missed.">                    &amp;&amp; (clickedPosition.getRow() == 1 || clickedPosition.getRow() == 8)) {</span>
<span class="nc" id="L522">                promotion();</span>
            }

            // en passant esetén a gyalog törlése
<span class="nc bnc" id="L526" title="All 4 branches missed.">            if (clickedPiece.getType() == PieceType.PAWN &amp;&amp; getPieceInActualPosition(clickedPosition) == null</span>
<span class="nc bnc" id="L527" title="All 4 branches missed.">                    &amp;&amp; (clickedPosition.getRow() == 3 || clickedPosition.getRow() == 6)</span>
<span class="nc bnc" id="L528" title="All 2 branches missed.">                    &amp;&amp; clickedPiece.getPosition().getColumn() != clickedPosition.getColumn()) {</span>
<span class="nc" id="L529">                enPassant();</span>
<span class="nc bnc" id="L530" title="All 2 branches missed.">            } else if (!wasTherePromotion) {</span>
<span class="nc" id="L531">                addMove(PGN_Formatter.getMoveFormatted(clickedPiece, movedTo, wasPieceTaken, actualPosition));</span>
            }

            // gyalog két lépés esetén a változó bebillentése igazra
<span class="nc bnc" id="L535" title="All 2 branches missed.">            if (clickedPiece.getType() == PieceType.PAWN</span>
<span class="nc bnc" id="L536" title="All 2 branches missed.">                    &amp;&amp; Math.abs(clickedPiece.getPosition().getRow() - clickedPosition.getRow()) == 2) {</span>
<span class="nc" id="L537">                ((Pawn) clickedPiece).setTwoMove();</span>
            }

            // a bábu &quot;mozgatása&quot; a lépés helyére
<span class="nc bnc" id="L541" title="All 2 branches missed.">            for (Piece piece : actualPosition) {</span>
<span class="nc bnc" id="L542" title="All 2 branches missed.">                if (clickedPiece.equals(piece)) {</span>
<span class="nc" id="L543">                    piece.setPosition(movedTo);</span>
                }
            }

            // következő játékos jön
<span class="nc bnc" id="L548" title="All 2 branches missed.">            if (nextMoveColor == PieceColor.WHITE) {</span>
<span class="nc" id="L549">                nextMoveColor = PieceColor.BLACK;</span>
<span class="nc" id="L550">            } else {</span>
<span class="nc" id="L551">                nextMoveColor = PieceColor.WHITE;</span>
            }

            // előléptetés esetén már ezek a parancsok megvoltak
<span class="nc bnc" id="L555" title="All 2 branches missed.">            if (!wasTherePromotion) {</span>
<span class="nc" id="L556">                clickedPiece.setPosition(clickedPosition);</span>
<span class="nc" id="L557">                lastMovePiece = clickedPiece;</span>
<span class="nc" id="L558">                lastMovePosition = clickedPosition;</span>
<span class="nc" id="L559">                clickedPiece.pieceHasMoved();</span>
            }

            // sáncolás
<span class="nc bnc" id="L563" title="All 2 branches missed.">            if (clickedPiece.getType() == PieceType.KING) {</span>
<span class="nc" id="L564">                castling();</span>
            }

<span class="nc" id="L567">            possibleMoves = null;</span>
<span class="nc" id="L568">        }</span>

        /**
         * Kattintás esetén felelős a bábu lépéseinek megjelenítéséért, lépések
         * lebonyolításáért
         */
        @Override
        public void mouseClicked(MouseEvent e) {
<span class="nc" id="L576">            int row = boardTable.rowAtPoint(e.getPoint());</span>
<span class="nc" id="L577">            int column = boardTable.columnAtPoint(e.getPoint());</span>

<span class="nc bnc" id="L579" title="All 4 branches missed.">            if (row &gt;= 0 &amp;&amp; column &gt;= 0) {</span>
<span class="nc" id="L580">                clickedPosition = new Position(column, 8 - row);</span>
<span class="nc" id="L581">                pieceThere = getPieceInActualPosition(clickedPosition);</span>

<span class="nc bnc" id="L583" title="All 4 branches missed.">                if (pieceThere != null &amp;&amp; pieceThere.getColor() == nextMoveColor) {</span>
<span class="nc" id="L584">                    clickedOnPiece();</span>
<span class="nc bnc" id="L585" title="All 2 branches missed.">                } else if (isInPossibleMove(clickedPosition)) {</span>
<span class="nc" id="L586">                    executeMove();</span>
<span class="nc" id="L587">                } else {</span>
                    // ha nem lépés vagy nem bábu, akkor null a két paraméter és nem történik semmi
<span class="nc" id="L589">                    possibleMoves = null;</span>
<span class="nc" id="L590">                    clickedPiece = null;</span>
                }

<span class="nc" id="L593">                boardTable.repaint();</span>
            }

            // véget ért már-e a játék
<span class="nc" id="L597">            checkBoardAfterEveryMove();</span>
<span class="nc" id="L598">        }</span>
    }

    /**
     * A JTable celláinak megjelenítéséért felelő belső osztály.
     * Megjeleníti a bábukat, a lehetséges lépéseket, felrajzolja a
     * mezők háttereit és az oszlopok/sorok nevét
     */
<span class="nc" id="L606">    static class CellRenderer extends DefaultTableCellRenderer {</span>
        /**
         * A sorok neveinek megjelenítéséért felel
         * 
         * @param row
         * @return
         */
        private static JLabel getRowLabel(int row) {
<span class="nc" id="L614">            JLabel label = new JLabel(&quot;        &quot; + Integer.toString(8 - row));</span>
<span class="nc" id="L615">            label.setOpaque(true);</span>
<span class="nc" id="L616">            label.setForeground(Color.black);</span>
<span class="nc" id="L617">            label.setBackground(Color.white);</span>
<span class="nc" id="L618">            return label;</span>
        }

        /**
         * Az oszlopok neveinek megjelenítéséért felel
         * 
         * @param column
         * @param row
         * @return
         */
        private static JLabel getColumnLabel(int column, int row) {
<span class="nc" id="L629">            Position pos = new Position(column, row + 1);</span>
<span class="nc" id="L630">            JLabel label = new JLabel(&quot;        &quot; + pos.columnToString().toUpperCase());</span>
<span class="nc" id="L631">            label.setOpaque(true);</span>
<span class="nc" id="L632">            label.setForeground(Color.black);</span>
<span class="nc" id="L633">            label.setBackground(Color.white);</span>
<span class="nc" id="L634">            return label;</span>
        }

        /**
         * A lehetséges lépéseket megjeleníti:
         * - ütés esetén pirossal
         * - sima lépés esetén kékkel
         * 
         * @param label
         * @param column
         * @param row
         */
        private static void drawMoves(JLabel label, int column, int row) {
<span class="nc bnc" id="L647" title="All 2 branches missed.">            for (Position p : possibleMoves) {</span>
<span class="nc" id="L648">                Position there = new Position(column, 8 - row);</span>

<span class="nc bnc" id="L650" title="All 2 branches missed.">                if (p.equals(there)) {</span>
<span class="nc" id="L651">                    label.setBackground(Color.blue);</span>

<span class="nc bnc" id="L653" title="All 2 branches missed.">                    for (Piece piece : actualPosition) {</span>
<span class="nc bnc" id="L654" title="All 2 branches missed.">                        if (piece.getPosition().equals(there)) {</span>
<span class="nc" id="L655">                            label.setBackground(Color.red);</span>
                        }
                    }
                }
            }
<span class="nc" id="L660">        }</span>

        /**
         * A tábla celláinak kirajzolásáért felelős függvény felüldefiniálása
         */
        @Override
        public Component getTableCellRendererComponent(JTable table, Object value, boolean isSelected, boolean hasFocus,
                int row, int column) {
<span class="nc bnc" id="L668" title="All 4 branches missed.">            if (column == 0 &amp;&amp; row == 8) {</span>
<span class="nc" id="L669">                return new JLabel();</span>
            }

<span class="nc bnc" id="L672" title="All 2 branches missed.">            if (column == 0) {</span>
<span class="nc" id="L673">                return getRowLabel(row);</span>
            }

<span class="nc bnc" id="L676" title="All 2 branches missed.">            if (row == 8) {</span>
<span class="nc" id="L677">                return getColumnLabel(column, row);</span>
            }

<span class="nc" id="L680">            JLabel label = new JLabel();</span>
<span class="nc" id="L681">            Position cellPosition = new Position(column, 8 - row);</span>
<span class="nc bnc" id="L682" title="All 2 branches missed.">            for (Piece piece : actualPosition) {</span>
<span class="nc bnc" id="L683" title="All 2 branches missed.">                if (piece.getPosition().equals(cellPosition)) {</span>
<span class="nc" id="L684">                    label.setIcon(new ImageIcon(&quot;piece_images/&quot; + piece.getImageName()));</span>
                }
            }

<span class="nc bnc" id="L688" title="All 2 branches missed.">            if ((row + column) % 2 == 0) {</span>
<span class="nc" id="L689">                label.setBackground(new Color(128, 128, 128));</span>
<span class="nc" id="L690">            } else {</span>
<span class="nc" id="L691">                label.setBackground(Color.white);</span>
            }

<span class="nc bnc" id="L694" title="All 2 branches missed.">            if (possibleMoves != null) {</span>
<span class="nc" id="L695">                drawMoves(label, column, row);</span>
            }

<span class="nc" id="L698">            label.setOpaque(true);</span>

<span class="nc" id="L700">            return label;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>